version: '3.8'

services:
  # Model Training Service
  training:
    build:
      context: .
      target: training
    image: lab-lens-training:latest
    volumes:
      - ./data-pipeline/data:/app/data-pipeline/data
      - ./models:/app/models
      - ./mlruns:/app/mlruns
      - ./logs:/app/logs
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - MLFLOW_TRACKING_URI=./mlruns
      - PYTHONPATH=/app
    command: >
      python src/training/train_with_tracking.py
      --data-path data-pipeline/data/processed/processed_discharge_summaries.csv
      --config configs/gemini_config.json
      --output-dir models/gemini
    networks:
      - lab-lens-network

  # MLflow Tracking Server (optional)
  mlflow:
    build:
      context: .
      target: base
    image: lab-lens-mlflow:latest
    ports:
      - "5000:5000"
    volumes:
      - ./mlruns:/app/mlruns
    environment:
      - MLFLOW_TRACKING_URI=sqlite:///mlruns/mlflow.db
    command: >
      mlflow ui
      --host 0.0.0.0
      --port 5000
      --backend-store-uri sqlite:///mlruns/mlflow.db
    networks:
      - lab-lens-network

  # Inference Service
  inference:
    build:
      context: .
      target: inference
    image: lab-lens-inference:latest
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - PYTHONPATH=/app
    networks:
      - lab-lens-network

networks:
  lab-lens-network:
    driver: bridge




